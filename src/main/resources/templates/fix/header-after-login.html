<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link th:href="@{/css/fix/header-after.css}" rel="stylesheet">
    <script th:src="@{/js/fix/header-after.js}"></script>
    <link href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/static/woff2/SUIT.css" rel="stylesheet">
    <title>MOOD TRIP - 로그인 후</title>
</head>

<body>
<header class="header" th:fragment="header">
    <div class="header-nav">
        <div class="header-container">
            <!-- MOOD TRIP 로고 -->
            <a th:href="@{/}">
                <div class="header-nav-logo-wrapper">
                    <div class="header-nav-logo">
                        <div class="header-logo-squares">
                            <div class="header-logo-square header-black"></div>
                            <div class="header-logo-square header-yellow"></div>
                            <div class="header-logo-square header-red"></div>
                            <div class="header-logo-square header-blue"></div>
                        </div>
                        <div class="header-logo-text">MOOD<br>TRIP</div>
                    </div>
                </div>
            </a>

            <!-- 좌측 메뉴 -->
            <div class="header-left-nav">
                <div class="header-left-nav-menu" data-menu="emotions">
                    <div class="header-main-header header-text-header">감정여행</div>
                </div>
                <div class="header-left-nav-menu" data-menu="companion">
                    <div class="header-main-header header-text-header">동행매칭</div>
                </div>
                <div class="header-left-nav-menu" data-menu="notice">
                    <div class="header-main-header header-text-header">공지사항</div>
                </div>
                <div th:if="${isAdmin}" class="header-left-nav-menu">
                    <a th:href="@{/admin}" class="header-main-header header-text-header">관리자</a>
                </div>
            </div>

            <!-- 검색창 (독립 영역) -->
            <div class="header-search-nav">
                <form class="header-logged-in-search-form" th:action="@{/emotion-search}" method="get" id="headerEmotionForm">
                    <!-- 대분류 -->
                    <select name="categoryId" id="headerCategorySelect" aria-label="감정 카테고리"
                            style="height:40px; padding:0 10px; border:1px solid #e5e7eb; border-radius:8px; margin-right:8px; min-width:150px;">
                        <option value="" disabled selected hidden>대분류 선택</option>
                        <option th:each="c : ${headerEmotionCategories}"
                                th:value="${c.emotionCategoryId}"
                                th:text="${c.emotionCategoryName}">
                        </option>
                    </select>

                    <!-- 소분류 -->
                    <select name="tagId" id="headerEmotionSelect" aria-label="감정(소분류)"
                            style="height:40px; padding:0 10px; border:1px solid #e5e7eb; border-radius:8px; margin-right:8px; min-width:150px;">
                        <option value="" disabled selected hidden>소분류 선택</option>
                    </select>

                    <!-- 기존 input은 숨김 -->
                    <input type="text" name="q" placeholder="감정을 입력하세요"
                           class="header-logged-in-emotion-search-input" id="loggedInHeaderEmotionSearchInput"
                           style="display:none;" aria-hidden="true" tabindex="-1" />

                    <button type="submit" class="header-logged-in-emotion-search-btn" aria-label="검색">
                        <img th:src="@{/image/default-common/search.png}" alt="검색" class="header-logged-in-search-icon"/>
                    </button>
                </form>
            </div>

            <!-- 로그인된 사용자 프로필 메뉴 -->
            <div class="header-right-nav">
                <div class="header-profile-menu-wrapper">
                    <!-- 헤더에 닉네임 표시 -->
                    <div class="header-profile-display">
                        <span class="header-profile-nickname-header" th:text="${currentMember.nickname}">닉네임</span>
                        <span class="header-profile-suffix">님</span>
                    </div>

                    <!-- 프로필 이미지 -->
                    <div class="header-profile-thumb" id="profileThumb">
                        <img th:src="@{${profileImage}}" alt="프로필" id="profileImg" /></div>

                    <!-- 드롭다운 -->
                    <div class="header-profile-dropdown" id="profileDropdown">
                        <div class="header-profile-info">
                            <div class="header-profile-nickname" th:text="${currentMember.nickname}">닉네임</div>
                            <div class="header-profile-email" th:text="${currentMember.email}">이메일</div>
                        </div>

                        <!-- 프로필 관리 버튼 + 배지 -->
                        <button class="header-profile-btn header-profile-manage-with-badge" id="profileManageBtn">
                            <span>프로필 관리</span>
                            <span class="header-notification-badge"
                                  th:if="${totalPendingRequests > 0}"
                                  th:text="${totalPendingRequests}">3</span>
                        </button>

                        <button class="header-logout-btn" id="logoutBtn">로그아웃</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 드롭다운 메뉴 -->
        <div class="header-dropdown-nav-container" style="top: 65px;">
            <div class="header-dropdown-nav">
                <div class="header-dropdown-menu-container" style="margin-left: 130px;">
                    <div class="header-dropdown-menu-list" id="emotions-dropdown" style="width: 145px;">
                        <a class="header-dropdown-menu-item" th:href="@{/emotion-search}">감정 관광지 찾기</a>
                        <a class="header-dropdown-menu-item" th:href="@{/weather}">날씨별 관광지 찾기</a>
                    </div>
                    <div class="header-dropdown-menu-list" id="companion-dropdown" style="width: 109px;">
                        <a class="header-dropdown-menu-item" th:href="@{/companion-rooms/create}">방 만들기</a>
                        <a class="header-dropdown-menu-item" th:href="@{/entering-room}">방 입장하기</a>
                        <a class="header-dropdown-menu-item" th:href="@{/mypage/my-matching}">스케줄 짜기</a>
                    </div>
                    <div class="header-dropdown-menu-list" id="notice-dropdown" style="width: 113px;">
                        <a class="header-dropdown-menu-item" th:href="@{/customer-center/announcement}">공지사항</a>
                        <a class="header-dropdown-menu-item" th:href="@{/customer-center/faq}">자주 묻는 질문</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- 검색창 카테고리/소분류 제어 스크립트 -->
<script th:inline="javascript">
    (function () {
        const categories = /*\[[${headerEmotionCategories}]]*/ [];
        const catSel = document.getElementById('headerCategorySelect');
        const emoSel = document.getElementById('headerEmotionSelect');

        function renderEmotions(categoryId) {
            emoSel.innerHTML = '<option value="" disabled selected hidden>소분류 선택</option>';
            if (!categoryId) return;
            const cat = (categories || []).find(c => String(c.emotionCategoryId) === String(categoryId));
            if (!cat || !cat.emotions) return;
            cat.emotions.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.tagId;
                opt.textContent = e.tagName;
                emoSel.appendChild(opt);
            });
        }

        catSel && catSel.addEventListener('change', () => {
            renderEmotions(catSel.value);
        });
    })();
</script>
</body>
</html>