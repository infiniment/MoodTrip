<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>무드 트립 - 방 입장 요청 관리</title>
    <link rel="stylesheet" th:href="@{/css/mypage/join-requests.css}">
    <link rel="stylesheet" th:href="@{/css/fix/header.css}">
    <link rel="stylesheet" th:href="@{/css/fix/footer.css}">
    <link rel="stylesheet" th:href="@{/css/fix/header-after.css}">
</head>
<body>
<!-- 로그인 상태에 따른 조건부 헤더 렌더링 -->
<div th:if="${isLoggedIn}">
    <th:block th:replace="~{fix/header-after-login :: header}"></th:block>
</div>
<div th:unless="${isLoggedIn}">
    <th:block th:replace="~{fix/header :: header}"></th:block>
</div>

<div>
    <div class="wrap">
        <div class="page">
            <div class="page-inner">
                <aside class="user-settings-nav">
                    <div class="account-settings">계정 설정</div>
                    <hr orientation="horizontal" class="horizontal-line">
                    <a class="my_profile" th:href="@{/mypage/my-profile}">내 정보</a>
                    <a class="my_matching" th:href="@{/mypage/my-matching}">매칭 정보</a>
                    <a class="join_requests active" th:href="@{/mypage/join-requests}">
                        방 입장 요청 관리
                        <!-- 🔥 서버에서 받은 총 대기 요청 수로 배지 표시 -->
                        <span class="notification-badge" id="join-requests-badge"
                              th:if="${totalPendingRequests > 0}"
                              th:text="${totalPendingRequests}">3</span>
                    </a>
                    <a class="my_reviews" th:href="@{/mypage/my-reviews}">내가 쓴 후기</a>
                    <a class="my_tourist_attraction_wishlist" th:href="@{/mypage/my-tourist-attraction-wishlist}">관광지 찜 목록</a>
                    <a class="change_password" th:href="@{/mypage/change-password}">비밀번호 변경 정보</a>
                    <a class="alarm" th:href="@{/mypage/alarm}">알림 설정</a>
                </aside>

                <main class="mypage_info">
                    <div class="total-wrapper">
                        <div class="requests-header">
                            <h1 class="info-title">방 입장 요청 관리</h1>
                        </div>

                        <!-- 🔥 통계 카드 - 서버 데이터 연동 -->
                        <div class="requests-stats">
                            <div class="stat-card">
                                <div class="stat-number" id="total-requests"
                                     th:text="${stats.totalRequests ?: 0}">0</div>
                                <div class="stat-label">총 요청</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="today-requests"
                                     th:text="${stats.todayRequests ?: 0}">0</div>
                                <div class="stat-label">오늘 요청</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="urgent-requests"
                                     th:text="${stats.urgentRequests ?: 0}">0</div>
                                <div class="stat-label">긴급 요청</div>
                            </div>
                        </div>

                        <!-- 🔥 필터 바 - 방 목록 동적 생성 -->
                        <div class="filter-bar">
                            <select class="filter-select" id="room-filter">
                                <option value="all">모든 방</option>
                                <!-- 서버에서 받은 방 목록으로 옵션 생성 -->
                                <option th:each="room : ${rooms}"
                                        th:value="${room.roomTitle}"
                                        th:text="${room.roomTitle}">방 제목</option>
                            </select>
                            <select class="filter-select" id="priority-filter">
                                <option value="all">모든 우선순위</option>
                                <option value="high">높음</option>
                                <option value="normal">보통</option>
                            </select>
                            <input type="text" class="search-input" placeholder="이름 또는 메시지로 검색..." id="search-requests">
                        </div>

                        <!-- 🔥 에러 메시지 표시 -->
                        <div th:if="${error}" class="error-message" style="background-color: #fee; color: #c33; padding: 1rem; margin: 1rem 0; border-radius: 4px;">
                            <p th:text="${error}">오류가 발생했습니다.</p>
                        </div>

                        <!-- ✅ 부분 렌더링 대상 fragment 선언 -->
                        <div id="main-wrapper" class="main-wrapper" th:fragment="main-wrapper">
                            <!-- 🔥 방 목록이 없는 경우 -->
                            <div th:if="${rooms == null or #lists.isEmpty(rooms)}" class="empty-section">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M12 6v6l4 2"></path>
                                </svg>
                                <h3>아직 만든 방이 없습니다</h3>
                                <p>방을 만들면 입장 요청을 관리할 수 있습니다.</p>
                                <a th:href="@{/creating-room}" class="btn-primary" style="margin-top: 1rem;">방 만들기</a>
                            </div>

                            <!-- 🔥 방별 요청 섹션 - 서버 데이터로 동적 생성 -->
                            <div th:each="room : ${rooms}" class="room-section" th:data-room-id="${room.roomId}">
                                <div class="room-header">
                                    <div>
                                        <h3 class="room-title" th:text="${room.roomTitle}">방 제목</h3>
                                        <div class="room-meta"
                                             th:text="${'여행 날짜: ' + room.travelDate + ' | 현재 인원: '
              + room.currentParticipants + '/' + room.maxParticipants + '명'}">
                                        </div>
                                    </div>
                                    <div class="waiting-count"
                                         th:classappend="${room.pendingRequestsCount == 0} ? 'no-requests' : ''"
                                         th:text="${room.pendingRequestsCount > 0} ? (${room.pendingRequestsCount} + '건 대기') : '요청 없음'">
                                        요청 없음
                                    </div>
                                </div>

                                <div class="requests-container">
                                    <!-- 🔥 해당 방에 신청이 있는 경우 -->
                                    <div th:if="${room.joinRequests != null and not #lists.isEmpty(room.joinRequests)}">
                                        <!-- 각 신청별로 반복 -->
                                        <div th:each="request : ${room.joinRequests}"
                                             class="request-item-detailed"
                                             th:data-request-id="${request.joinRequestId}">

                                            <div class="request-checkbox">
                                                <input type="checkbox" class="request-select"
                                                       th:data-request-id="${request.joinRequestId}">
                                            </div>

                                            <div class="request-avatar-large">
                                                <img th:src="${request.applicantProfileImage}"
                                                     th:alt="${request.applicantNickname}"
                                                     onerror="this.src='/image/fix/moodtrip.png'">
                                            </div>

                                            <div class="request-details">
                                                <div class="request-name-large">
                                                    <span th:text="${request.applicantNickname}">신청자명</span>
                                                    <span class="priority-badge"
                                                          th:classappend="${request.priority == 'HIGH'} ? 'priority-high' : 'priority-normal'"
                                                          th:text="${request.priority == 'HIGH'} ? '높음' : '보통'">보통</span>
                                                </div>

                                                <div class="request-message" th:text="${request.message}">신청 메시지</div>

                                                <div class="request-meta-detailed">
                                                    <span class="separator">|</span>
                                                    <span th:text="${request.appliedAt} + ' 신청'">신청 시간</span>
                                                    <span class="time-ago" th:text="${request.timeAgo}">시간 전</span>
                                                </div>
                                            </div>

                                            <div class="request-actions-detailed">
                                                <button class="btn-approve"
                                                        th:data-request-id="${request.joinRequestId}"
                                                        th:data-room-id="${room.roomId}">승인</button>
                                                <button class="btn-reject"
                                                        th:data-request-id="${request.joinRequestId}"
                                                        th:data-room-id="${room.roomId}">거절</button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 🔥 해당 방에 신청이 없는 경우 -->
                                    <div th:if="${room.joinRequests == null or #lists.isEmpty(room.joinRequests)}"
                                         class="empty-section">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M12 6v6l4 2"></path>
                                        </svg>
                                        <h4>아직 입장 요청이 없습니다</h4>
                                        <p>새로운 참가 요청이 오면 여기에 표시됩니다.</p>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- /main-wrapper -->
                    </div>
                </main>
            </div>
        </div>
    </div>
</div>

<!-- 확인 모달 -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="confirmTitle">확인</h3>
            <button class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmMessage">작업을 진행하시겠습니까?</p>
            <div id="confirmDetails" class="confirm-details"></div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel">취소</button>
            <button class="btn-confirm" id="confirmAction">확인</button>
        </div>
    </div>
</div>

<!-- 알림 토스트 (동적 생성) -->
<div id="toast-container"></div>

<!-- 🔥 JavaScript에서 사용할 데이터를 JSON으로 전달 -->
<script th:inline="javascript">
    // 서버 데이터를 JavaScript로 전달
    window.serverData = {
        rooms: /*[[${rooms}]]*/ [],
        stats: /*[[${stats}]]*/ {},
        totalPendingRequests: /*[[${totalPendingRequests}]]*/ 0,
        hasRequests: /*[[${hasRequests}]]*/ false
    };

    console.log('🔥 서버에서 받은 데이터:', window.serverData);
</script>

<script th:src="@{/js/mypage/join-requests.js}"></script>
<th:block th:replace="~{fix/footer :: footer}"></th:block>

<script th:src="@{/js/fix/header.js}"></script>
<script th:src="@{/js/fix/header-after.js}"></script>
</body>
</html>
